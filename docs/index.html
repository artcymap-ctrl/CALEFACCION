<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</title>
  <style>
    :root{--bg:#0b1220;--fg:#e7eef7;--muted:#9db0c6;--card:#121a2b;--accent:#4aa3ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
         background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid #1c2740;background:#0d1628}
    h1{margin:0;font-size:1.1rem}
    .sub{color:var(--muted);font-size:.9rem;margin-top:6px}
    main{padding:14px}
    .card{background:var(--card);border:1px solid #1c2740;border-radius:14px;padding:12px}
    .toprow{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
    a{color:#9fd0ff}
    #msg{color:#ff9a8a;margin-top:8px}
    #chart{height:60vh;min-height:360px}
  </style>
  <!-- Chart.js + date adapter (imprescindible para ejes de tiempo) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
  <header>
    <h1>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</h1>
    <div class="sub">Fuente: AEMET · captura diaria automática · histórico incremental</div>
  </header>

  <main>
    <div class="card">
      <div class="toprow">
        <div>CSV histórico:
          <a id="csvLink" href="data/9091R_temp_history.csv" target="_blank" rel="noopener">data/9091R_temp_history.csv</a>
        </div>
        <div id="updatedLbl" class="sub"></div>
      </div>
      <canvas id="chart"></canvas>
      <div id="msg"></div>
    </div>
  </main>

<script>
(async function(){
  // 1) Dónde está el CSV (intenta Pages y si no, RAW)
  const RELATIVE = 'data/9091R_temp_history.csv';
  const RAW = 'https://raw.githubusercontent.com/artcymap-ctrl/CALEFACCION/main/data/9091R_temp_history.csv';
  const csvLink = document.getElementById('csvLink');
  const updatedLbl = document.getElementById('updatedLbl');
  const msg = document.getElementById('msg');

  async function tryFetch(url){
    const bust = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
    const r = await fetch(bust, {cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.text();
  }

  let csvText = null, used = null;
  try{
    csvText = await tryFetch(RELATIVE);
    used = RELATIVE;
  }catch(_){
    csvText = await tryFetch(RAW);
    used = RAW;
    csvLink.href = RAW; // actualiza el link visible si usamos RAW
    csvLink.textContent = 'raw.githubusercontent.com…/9091R_temp_history.csv';
  }

  // 2) Parseo sencillo del CSV (cabeceras: date_local,time_local,datetime_utc,temp_c,source)
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    if(lines.length < 2) return [];
    const header = lines.shift().split(',');
    const iDT = header.indexOf('datetime_utc');
    const iT  = header.indexOf('temp_c');
    if(iDT<0 || iT<0) throw new Error('Cabeceras no esperadas: '+header.join(', '));
    const pts = [];
    for(const ln of lines){
      if(!ln.trim()) continue;
      const parts = ln.split(',');
      const d = new Date(parts[iDT]);
      const y = Number(parts[iT]);
      if(!isNaN(d.getTime()) && isFinite(y)) pts.push({x: d, y});
    }
    return pts.sort((a,b)=>a.x-b.x);
  }

  let points = [];
  try{
    points = parseCSV(csvText);
  }catch(e){
    msg.textContent = 'Error parseando CSV: ' + e.message;
    return;
  }

  if(points.length === 0){
    msg.textContent = 'No hay puntos para dibujar.';
    return;
  }

  // 3) Último dato visible
  const last = points[points.length-1].x;
  updatedLbl.textContent = 'Último dato: ' + last.toLocaleString('es-ES');

  // 4) Dibujo con Chart.js (eje temporal)
  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'Temperatura (ºC)',
        data: points,
        tension: 0.2,
        pointRadius: 0,
        borderWidth: 2,
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: false, // ya damos {x:Date, y:Number}
      scales: {
        x: {
          type: 'time',
          time: { tooltipFormat: "dd/MM/yyyy HH:mm" },
          ticks: { color: '#a9c2de', maxRotation: 0, autoSkip: true },
          title: { display: true, text: 'Fecha y hora' }
        },
        y: {
          ticks: { color: '#a9c2de' },
          title: { display: true, text: 'ºC' }
        }
      },
      plugins: {
        legend: { labels: { color: '#cfe6ff' } },
        tooltip: { intersect: false, mode: 'index' }
      }
    }
  });

  // Info de dónde se cargó
  console.log('CSV cargado desde:', used);
})();
</script>
</body>
</html>
