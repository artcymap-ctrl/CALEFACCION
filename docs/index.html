<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</title>

  <!-- Chart.js + adaptador date-fns -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/locale/es/index.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;--fg:#e7eef7;--mut:#a7b8cf;--card:#121a2b;
      --accent:#4aa3ff;--ok:#27c93f;--err:#ff453a
    }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Roboto,Arial}
    header{padding:16px 20px;border-bottom:1px solid #1c2740;background:#0d1628}
    h1{margin:0;font-size:1.15rem}
    .sub{color:var(--mut);font-size:.9rem;margin-top:6px}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .panel{background:var(--card);border:1px solid #1c2740;border-radius:14px;padding:12px}
    a{color:#9dccff}
    .row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    #chartWrap{height:480px;margin-top:10px}
    canvas{background:#0b1324;border-radius:8px;border:1px solid #1c2740;width:100%;height:100%}
    .mut{color:var(--mut)} .ok{color:var(--ok)} .bad{color:var(--err)}
  </style>
</head>
<body>
<header>
  <h1>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</h1>
  <div class="sub">Fuente: AEMET · captura diaria automática · histórico incremental</div>
</header>

<main>
  <section class="panel">
    <div class="row">
      <div>CSV histórico: <a id="csvLink" href="data/9091R_temp_history.csv">data/9091R_temp_history.csv</a></div>
      <div class="mut">Último dato: <span id="updatedLbl">—</span></div>
    </div>
    <div id="chartWrap"><canvas id="chart"></canvas></div>
    <div id="msg" class="mut"></div>
  </section>
</main>

<script>
(async function(){
  const CSV_URL = "https://raw.githubusercontent.com/artcymap-ctrl/CALEFACCION/main/data/9091R_temp_history.csv";
  const csvLink   = document.getElementById('csvLink');
  const updatedEl = document.getElementById('updatedLbl');
  const msg       = document.getElementById('msg');

  const bust = `?_t=${Date.now()}`;
  csvLink.href = CSV_URL;

  function setMsg(t,c='mut'){ msg.textContent=t; msg.className=c; }

  async function fetchCSV(url){
    const r=await fetch(url);
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.text();
  }

  function parseCSV(text){
    const lines=text.trim().split(/\r?\n/);
    if(lines.length<2) return [];
    const headers=lines[0].split(',');
    const iDate=headers.indexOf('datetime_utc');
    const iTemp=headers.indexOf('temp_c');
    if(iDate===-1||iTemp===-1) throw new Error("Cabeceras no válidas");
    const pts=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(',');
      const d=new Date(cols[iDate].trim());
      const y=parseFloat(cols[iTemp]);
      if(!isNaN(d)&&!isNaN(y)) pts.push({x:d,y});
    }
    return pts;
  }

  let points=[];
  try{
    setMsg("Cargando datos…");
    const txt=await fetchCSV(CSV_URL+bust);
    points=parseCSV(txt);
    setMsg(`OK: ${points.length} registros.`,'ok');
  }catch(e){
    setMsg("Error cargando CSV: "+e.message,'bad');
    return;
  }

  if(points.length===0){setMsg("Sin datos.","bad");return;}

  points.sort((a,b)=>a.x-b.x);
  const last=points.at(-1);
  updatedEl.textContent=new Intl.DateTimeFormat('es-ES',{dateStyle:'short',timeStyle:'short'}).format(last.x);

  // Escala Y razonable
  const temps=points.map(p=>p.y);
  const tMin=Math.min(...temps),tMax=Math.max(...temps);
  const pad=Math.max(0.3,(tMax-tMin)*0.08);
  const yMin=Math.floor((tMin-pad)*10)/10;
  const yMax=Math.ceil((tMax+pad)*10)/10;
  const step=(tMax-tMin)<=6?0.5:1;

  const ctx=document.getElementById('chart').getContext('2d');
  new Chart(ctx,{
    type:'line',
    data:{datasets:[{
      label:'Temperatura (ºC)',
      data:points,
      borderColor:'#4aa3ff',
      borderWidth:2,
      pointRadius:1.5,
      pointHitRadius:6,
      tension:0.25,
      spanGaps:true
    }]},
    options:{
      animation:false,
      normalized:true,
      parsing:false,
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{
          type:'time',
          time:{
            unit:'hour',
            tooltipFormat:'dd/MM/yyyy HH:mm'
          },
          adapters:{ date:{ zone:'UTC' } }, // <=== CLAVE: fechas UTC válidas
          ticks:{ color:'#a9c2de', source:'data', maxRotation:0 },
          grid:{ color:'rgba(255,255,255,0.07)' },
          title:{ display:true,text:'Fecha y hora'}
        },
        y:{
          suggestedMin:yMin,suggestedMax:yMax,
          ticks:{ stepSize:step, color:'#a9c2de' },
          grid:{ color:'rgba(255,255,255,0.07)' },
          title:{ display:true,text:'ºC'}
        }
      },
      plugins:{
        legend:{ labels:{ color:'#cfe6ff' } },
        tooltip:{ intersect:false,mode:'index' },
        decimation:{ enabled:false }
      }
    }
  });
})();
</script>
</body>
</html>
