<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</title>
  <style>
    :root{
      --bg:#0b1220;--fg:#e7eef7;--muted:#9db0c6;--card:#121a2b;--accent:#4aa3ff
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    header{padding:16px 20px;border-bottom:1px solid #1c2740;background:#0e1628}
    h1{margin:0;font-size:1.1rem}
    .sub{color:var(--muted);font-size:.85rem;margin-top:4px}
    main{padding:14px}
    .panel{background:var(--card);border:1px solid #1c2740;border-radius:14px;padding:12px}
    #chartWrap{height:60vh;min-height:360px}
    canvas{width:100%;height:100%}
    a{color:var(--accent)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .muted{color:var(--muted);font-size:.85rem}
    .err{color:#ff6b6b}
  </style>
  <!-- Chart.js + date adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
  <header>
    <h1>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</h1>
    <div class="sub">Fuente: AEMET · captura diaria automática · histórico incremental</div>
  </header>

  <main>
    <section class="panel">
      <div class="row">
        <div class="muted">CSV histórico: <a id="csvLink" href="#" target="_blank" rel="noopener">data/9091R_temp_history.csv</a></div>
        <div class="muted" id="updatedLbl">Cargando…</div>
      </div>
      <div id="chartWrap"><canvas id="chart"></canvas></div>
      <div class="muted" id="msg"></div>
    </section>
  </main>

<script>
(async function(){
  const CSV_URL = 'data/9091R_temp_history.csv';
  const csvLink = document.getElementById('csvLink');
  const updatedLbl = document.getElementById('updatedLbl');
  const msg = document.getElementById('msg');

  // Añade cache-busting y actualiza el link visible
  const bust = Date.now();
  const urlWithBust = CSV_URL + '?t=' + bust;
  csvLink.href = urlWithBust;

  // Utilidad: detectar delimitador (coma o punto y coma)
  function detectDelimiter(headerLine){
    // Si hay más ; que , asumimos ;
    const commas = (headerLine.match(/,/g)||[]).length;
    const semis  = (headerLine.match(/;/g)||[]).length;
    return semis > commas ? ';' : ',';
  }

  // Parseo CSV simple y robusto para nuestro caso (líneas pequeñas)
  function parseCSV(text){
    // Normaliza saltos
    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
    const lines = text.split('\n');
    if(lines.length === 0) return [];

    const delimiter = detectDelimiter(lines[0]);
    const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());

    // Índices de columnas que nos interesan (acepta nombres alternativos)
    const idxDatetime = ['datetime_utc','time_utc','datetime','fecha_hora_utc'].map(n => headers.indexOf(n)).find(i => i>=0);
    const idxTemp     = ['temp_c','temperatura (ºc)','temperatura','ta','t'].map(n => headers.indexOf(n)).find(i => i>=0);

    if(idxDatetime == null || idxDatetime < 0){
      throw new Error('No encuentro columna de fecha/tiempo (datetime_utc). Cabeceras: ' + headers.join(', '));
    }
    if(idxTemp == null || idxTemp < 0){
      throw new Error('No encuentro columna de temperatura (temp_c o equivalente). Cabeceras: ' + headers.join(', '));
    }

    const rows = [];
    for(let i=1;i<lines.length;i++){
      const line = lines[i].trim();
      if(!line) continue;
      const parts = line.split(delimiter);
      // seguridad: si el CSV tuviera comas dentro, este parser simple no las manejaría.
      // Para nuestros ficheros de AEMET, no se usan comas en campos, así que es seguro.

      const dtRaw = (parts[idxDatetime]||'').trim();
      const tRaw  = (parts[idxTemp]||'').trim();

      // Normaliza número (coma decimal -> punto)
      const t = parseFloat(tRaw.replace(',', '.'));
      // Chart.js con adapter date-fns acepta ISO (Z o +00:00). Nuestro CSV trae ISO Z.
      const d = new Date(dtRaw);

      if (!isNaN(d.getTime()) && !isNaN(t)) {
        rows.push({ x: d.toISOString(), y: t });
      }
    }
    return rows;
  }

  // Descarga CSV
  let data = [];
  try{
    const r = await fetch(urlWithBust, { cache: 'no-store' });
    if(!r.ok) throw new Error('HTTP '+r.status);
    const text = await r.text();
    data = parseCSV(text);

    if(data.length === 0) throw new Error('CSV vacío o no parseable.');

    // Muestra “última fecha” del histórico
    const maxX = data.reduce((acc, p) => Math.max(acc, new Date(p.x).getTime()), 0);
    const last = new Date(maxX);
    updatedLbl.textContent = 'Último dato: ' + last.toLocaleString('es-ES', { timeZone: 'Europe/Madrid' });

  }catch(e){
    msg.innerHTML = '<span class="err">Error cargando CSV: '+ (e && e.message ? e.message : e) +'</span>';
    updatedLbl.textContent = '—';
    return;
  }

  // Grafica
  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'Temperatura (ºC)',
        data,
        tension: 0.2,
        pointRadius: 0,
        spanGaps: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: false, // usamos {x,y}
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'hour',
            tooltipFormat: 'yyyy-MM-dd HH:mm'
          },
          ticks: { color: '#a9c2de' },
          title: { display: true, text: 'Fecha y hora' }
        },
        y: {
          ticks: { color: '#a9c2de' },
          title: { display: true, text: 'ºC' }
        }
      },
      plugins: {
        legend: { labels: { color: '#cfe6ff' } }
      }
    }
  });

})();
</script>
</body>
</html>
