<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</title>

  <!-- Chart.js + adaptador de fechas (date-fns) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/locale/es/index.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --fg:#e7eef7; --mut:#a7b8cf; --card:#121a2b;
      --accent:#4aa3ff; --accent2:#b074ff; --ok:#27c93f; --err:#ff453a
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial}
    header{padding:16px 20px;border-bottom:1px solid #1c2740;background:linear-gradient(180deg,#0d1628 0%, #0b1220 60%)}
    h1{margin:0;font-size:1.15rem}
    .sub{color:var(--mut);font-size:.9rem;margin-top:6px}
    main{padding:16px;max-width:1200px;margin:0 auto}
    .panel{background:var(--card);border:1px solid #1c2740;border-radius:14px;padding:12px}
    a{color:#9dccff}
    .row{display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap}
    #chartWrap{height:480px}         /* puedes ajustar la altura aquí */
    canvas{background:#0b1324;border-radius:8px;border:1px solid #1c2740;width:100%;height:100%}
    .mut{color:var(--mut)}
    #msg{margin-top:8px}
    .ok{color:var(--ok)} .warn{color:#ffbd2e} .bad{color:var(--err)}
  </style>
</head>
<body>
  <header>
    <h1>Temperaturas horarias · Vitoria-Gasteiz (Foronda 9091R)</h1>
    <div class="sub">Fuente: AEMET · captura diaria automática · histórico incremental</div>
  </header>

  <main>
    <section class="panel">
      <div class="row">
        <div>CSV histórico: <a id="csvLink" href="data/9091R_temp_history.csv">data/9091R_temp_history.csv</a></div>
        <div class="mut">Último dato: <span id="updatedLbl">—</span></div>
      </div>
      <div id="chartWrap" style="margin-top:10px;">
        <canvas id="chart"></canvas>
      </div>
      <div id="msg" class="mut"></div>
    </section>
  </main>

<script>
(async function(){
  // === CONFIGURACIÓN ===
  const CSV_URL  = 'data/9091R_temp_history.csv'; // mismo origen (repo Pages)
  const TZ_LOCALE = window.es || undefined;       // locale ES para formateo date-fns

  const csvLink   = document.getElementById('csvLink');
  const updatedEl = document.getElementById('updatedLbl');
  const msg       = document.getElementById('msg');

  // cache-busting para evitar servir CSV antiguo
  const bust = `?_t=${Date.now()}`;
  csvLink.href = CSV_URL + bust;

  function setMsg(text, cls=''){
    msg.textContent = text;
    msg.className = cls ? cls : 'mut';
  }

  // === DESCARGA CSV ===
  async function fetchCSV(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.text();
  }

  // === PARSEO CSV SIMPLE (cabeceras conocidas) ===
  function parseCSV(text){
    // Esperado: date_local,time_local,datetime_utc,temp_c,source
    const lines = text.split(/\r?\n/).filter(Boolean);
    if (lines.length <= 1) return [];

    const header = lines[0].split(',').map(h => h.trim());
    const iDate = header.indexOf('datetime_utc');
    const iTemp = header.indexOf('temp_c');
    if(iDate === -1 || iTemp === -1){
      throw new Error('CSV sin cabeceras datetime_utc/temp_c');
    }

    const pts = [];
    for(let i=1;i<lines.length;i++){
      const row = lines[i];
      // dividir conservador: el CSV que generas no tiene comas escapadas en estas columnas
      const cols = row.split(',');
      const dStr = cols[iDate]?.trim();
      const tStr = cols[iTemp]?.trim();

      if(!dStr || !tStr) continue;

      const d = new Date(dStr);
      const y = Number(tStr);
      if (!isFinite(d.getTime()) || !isFinite(y)) continue;
      pts.push({ x: d, y });
    }
    return pts;
  }

  // === CARGA Y DIBUJO ===
  let points = [];
  try{
    setMsg('Cargando datos…');
    const txt = await fetchCSV(CSV_URL + bust);
    points = parseCSV(txt);
    if(points.length === 0){
      setMsg('CSV sin datos válidos.', 'warn');
    } else {
      setMsg(`OK: ${points.length} registros.`, 'ok');
    }
  }catch(e){
    console.error(e);
    setMsg('Error cargando CSV: ' + (e?.message || e), 'bad');
    return;
  }

  // ordenar por fecha por si viniese alterno
  points.sort((a,b)=> a.x - b.x);

  // etiqueta de “último dato”
  if(points.length){
    const last = points[points.length - 1];
    // mostramos en horario local del navegador
    const f = new Intl.DateTimeFormat('es-ES', { dateStyle:'short', timeStyle:'short' });
    updatedEl.textContent = f.format(last.x);
  } else {
    updatedEl.textContent = '—';
  }

  // === AJUSTES ESCALA Y ===
  const temps = points.map(p => p.y);
  const tMin = Math.min(...temps);
  const tMax = Math.max(...temps);
  const pad = Math.max(0.3, (tMax - tMin) * 0.08);
  const yMin = Math.floor((tMin - pad) * 10) / 10;
  const yMax = Math.ceil((tMax + pad) * 10) / 10;
  const step = (tMax - tMin) <= 6 ? 0.5 : 1;

  // === CREAR GRÁFICO ===
  const ctx = document.getElementById('chart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [{
        label: 'Temperatura (ºC)',
        data: points,            // {x: Date, y: Number}
        borderWidth: 2,
        pointRadius: 1.5,
        pointHitRadius: 6,
        tension: 0.2,
        spanGaps: true
      }]
    },
    options: {
      // Evita “hinchado y contracción” inicial
      animation: { duration: 0 },
      resizeDelay: 0,
      normalized: true,

      responsive: true,
      maintainAspectRatio: false,
      parsing: false,                 // usamos {x,y} ya preparados

      interaction: { intersect: false, mode: 'nearest' },

      scales: {
        x: {
          type: 'time',
          // unidad fijada para evitar espaciados raros
          time: {
            unit: 'hour',
            displayFormats: { hour: 'd/M HH:mm' },
            tooltipFormat: 'dd/MM/yyyy HH:mm'
          },
          adapters: { date: { locale: TZ_LOCALE } },
          ticks: {
            source: 'data',            // solo posiciones de tus puntos
            maxRotation: 0,
            autoSkip: true,
            color: '#a9c2de'
          },
          title: { display: true, text: 'Fecha y hora' },
          grid: { color: 'rgba(255,255,255,0.06)' }
        },
        y: {
          suggestedMin: yMin,
          suggestedMax: yMax,
          ticks: { stepSize: step, color: '#a9c2de' },
          title: { display: true, text: 'ºC' },
          grid: { color: 'rgba(255,255,255,0.06)' }
        }
      },
      plugins: {
        legend: { labels: { color: '#cfe6ff' } },
        tooltip: { intersect: false, mode: 'index' },
        // No reducir puntos automáticamente (queremos verlos todos)
        decimation: { enabled: false }
      }
    }
  });
})();
</script>
</body>
</html>
